<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC   "-//mybatis.org//DTD Mapper 3.0//EN"
     "http://mybatis.org/dtd/mybatis-3-mapper.dtd"
>
<mapper namespace="com.one.mat.admin.dao.MemberListDAO">

	<select id="memberList" resultType="com.one.mat.member.dto.MemberDTO">
  		SELECT m.member_idx, m.member_id, m.member_name, m.member_phone, m.member_email, 
  		m.member_dongAddr, m.member_subs, m.member_renew, m.member_loginLock, 
  		(SELECT s.subsType_code FROM subs s WHERE s.member_idx = m.member_idx) 
  		FROM member m ORDER BY m.member_idx DESC
  		LIMIT #{param1} OFFSET #{param2}
  	</select>
  	
  	<select id="totalPage" resultType="int">
		SELECT CEIL(COUNT(member_idx)/#{param1}) AS pages FROM member
	</select>
  	
  	<select id="memberDetail" resultType="com.one.mat.member.dto.MemberDTO">
  		SELECT m.member_idx, m.member_id, m.member_name, m.member_phone, m.member_email, m.member_nickName, 
  			m.member_roadAddr, m.member_parcelAddr, m.member_detailAddr, m.member_dongAddr, m.member_birth, 
  			m.member_gender, m.member_regDate, m.member_subs, m.member_renew, m.member_loginLock, 
  			m.member_quit, s.subsType_code, sh.subsHistory_start, sh.subsHistory_exp
		FROM member m
		LEFT JOIN subs s ON m.member_idx = s.member_idx
		LEFT JOIN (
		    SELECT sh.member_idx, 
		           MAX(sh.subsHistory_start) as subsHistory_start, 
		           MAX(sh.subsHistory_exp) as subsHistory_exp
		    FROM subsHistory sh
		    WHERE sh.member_idx = #{param1}
		    GROUP BY sh.member_idx
		) sh ON m.member_idx = sh.member_idx
		WHERE m.member_idx = #{param1}		
  	</select>
  	
  	<select id="memberSearch" resultType="com.one.mat.member.dto.MemberDTO">
  		SELECT m.member_idx, m.member_id, m.member_name, m.member_phone, m.member_email, 
  		m.member_dongAddr, m.member_subs, m.member_renew, m.member_loginLock, 
  		(SELECT s.subsType_code FROM subs s WHERE s.member_idx = m.member_idx) FROM member m  
  		WHERE 
  		<choose>
	        <when test="param1=='member_id'">
	            'm.member_id' LIKE CONCAT('%', #{param2}, '%')
	        </when>
	        <when test="param1=='member_name'">
	            'm.member_name' LIKE CONCAT('%', #{param2}, '%')
	        </when>
	        <when test="param1=='member_dongAddr'">
	            'm.member_dongAddr' LIKE CONCAT('%', #{param2}, '%')
	        </when>
	    </choose>  		
  		ORDER BY m.member_idx DESC
  		LIMIT #{param3} OFFSET #{param4}
  	</select>
  	
  	<select id="totalPageWithSearch" resultType="int">
  		SELECT CEIL(COUNT(member_idx)/#{param1}) AS pages FROM member
  		WHERE
  		<choose>
	        <when test="param2=='member_id'">
	            'm.member_id' LIKE CONCAT('%', #{param3}, '%')
	        </when>
	        <when test="param2=='member_name'">
	            'm.member_name' LIKE CONCAT('%', #{param3}, '%')
	        </when>
	        <when test="param2=='member_dongAddr'">
	            'm.member_dongAddr' LIKE CONCAT('%', #{param3}, '%')
	        </when>
	    </choose>
  	</select>
  	
  	
</mapper>  