<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.one.mat.chatting.dao.ChattingDAO">
	<!-- <select id="boardList" resultType="kr.co.gudi.dto.BoardDTO">
		SELECT b.idx, b.subject, b.user_name, b.bHit, (SELECT count(idx) FROM photo p WHERE b.idx= p.idx) AS img FROM bbs b
	</select> -->
	<select id="proIdx" resultType="com.one.mat.member.dto.ProfileDTO">
		SELECT pro_idx FROM pro WHERE member_idx = #{param1} 
	</select>
	<select id="chatIdx" resultType="com.one.mat.chatting.dto.ChattingDTO">
		SELECT chat_idx , pro_recvIdx AS pro_idx FROM chat c 
		INNER JOIN `match` m ON c.match_idx = m.match_idx 
		WHERE m.pro_sendIdx = #{param1}
		UNION ALL
		SELECT chat_idx , pro_sendIdx AS pro_idx FROM chat c 
		INNER JOIN `match` m ON c.match_idx = m.match_idx 
		WHERE m.pro_recvIdx = #{param1}
	</select>
	
	<select id="chatPhotoInfo" resultType="com.one.mat.chatting.dto.ChattingDTO">
	SELECT pt.photo_fileName
	FROM pro p 
	INNER JOIN photo pt ON pt.photo_idfNum = p.pro_idx 
	WHERE pt.photo_type = 4 AND p.pro_idx = #{param1} ORDER BY pt.photo_id ASC LIMIT 1;
	</select>
	
	<select id="chatProInfo" resultType="com.one.mat.chatting.dto.ChattingDTO">
	SELECT bt.breedType, p.pro_dogName
	FROM pro p 
	INNER JOIN breed b ON p.pro_idx = b.pro_idx
	INNER JOIN breedtype bt ON b.breedType_code = bt.breedType_code
	WHERE p.pro_idx = #{param1}
	</select>
	
	<select id="chatMsgInfo" resultType="com.one.mat.chatting.dto.ChattingDTO">
	SELECT
	CASE
	WHEN DATE(c.chatMsg_regDate) = DATE(NOW()) THEN TIME_FORMAT(c.chatMsg_regDate, '%H:%i')
	ELSE DATE_FORMAT(c.chatMsg_regDate , '%Y-%m-%d')
	END AS msgTime
	,CASE 
	WHEN CHAR_LENGTH(c.chatMsg_msg) > 20 THEN CONCAT(SUBSTRING(c.chatMsg_msg, 1, 20), '...')
	ELSE c.chatMsg_msg
	END AS chatMsg_msg
	,(SELECT count(chatMsg_read) from chatmsg where chat_idx=#{param1} and chatMsg_read ='N') as chatMsg_read
	FROM chatmsg c WHERE chat_idx =#{param1} ORDER BY chatMsg_regDate DESC LIMIT 1
	</select>
	
	<!-- <select id="totalPage" resultType="int">
		SELECT CEIL(COUNT(idx)/#{param1}) AS pages FROM bbs
	</select> -->
	
	<select id="chatRoomListDo" resultType="com.one.mat.chatting.dto.ChattingDTO">
	SELECT * FROM chatmsg
	</select>
	
	<!-- <select id="chatRoomListDo" resultType="com.one.mat.chatting.dto.chattingDTO">
	SELECT * FROM chatmsg 
	WHERE (pro_recvIdx = #{pro_recvIdx} AND pro_sendIdx = #{pro_sendIdx} ) 
	OR (pro_recvIdx = #{pro_sendIdx} AND pro_sendIdx = #{pro_recvIdx} ) 
	AND chatMsg_idx > #{chatMsg_idx} ORDER BY chatMsg_regDate
	</select>
	<insert id="chatSaveDo">
	INSERT INTO chatmsg(
	chatMsg_idx
	,chat_idx
	,pro_sendIdx
	,pro_recvIdx
	,chatMsg_msg
	,chatMsg_read
	,chatMsg_regDate) 
	VALUES
	(,NOW())
	</insert> -->
 
  </mapper>